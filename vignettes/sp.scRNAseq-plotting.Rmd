---
title: "sp.scRNAseq Plotting Vignette"
author: "Jason T. Serviss and Martin Enge"
date: '`r Sys.Date()`'
output:
    html_document:
        theme: flatly
        toc: yes
vignette: >
    %\VignetteIndexEntry{ClusterSignificance Vignette} 
    %\VignetteEngine{knitr::rmarkdown} 
    %\usepackage[utf8]{inputenc}
    %\SweaveUTF8
---

```{r, eval = FALSE, echo = FALSE}
Use the countsSorted2 dataset here instead.
Markers defined by ksTest
HOS: ALDH1A2, BASP1, BGN, BHMT2, COL1A1, COL1A2, COL3A1, FOXR1, GTSF1, LUM
HCT116: ADIRF, ANXA3, AREG, CBR1, CLDN7, DMKN, EPCAM, EREG, KRT19, KRTCAP3
A375: HLA-DRA, IL13RA2, LOC441601, LOC728715, MAGEA4, MAGEA6, MT1E, OCIAD2, SOX10, XIST 
```


```{r, message = FALSE}
packages <- c(
    "sp.scRNAseq",
    "sp.scRNAseqData",
    "printr",
    "ggthemes",
    "tidyverse",
    "tidygraph",
    "ggraph",
    "viridis"
)
purrr::walk(packages, library, character.only = TRUE)
rm(packages)
```

```{r}
sng <- stringr::str_detect(colnames(countsSorted2), "^s")
cObjSng <- spCounts(countsSorted2[, sng], countsSortedERCC2[, sng])
cObjMul <- spCounts(countsSorted2[, !sng], countsSortedERCC2[, !sng])
uObj <- spUnsupervised(cObjSng, type = "max", max = 2000)

#rename classes
positions <- str_extract(colnames(getData(cObjSng, "counts")), "...$")
newClass <- case_when(
  positions == "E03" ~ "A375", #what is this? sorting issue?
  positions %in% paste0(sort(rep(LETTERS[1:8], 4)), c("01", "02", "03", "04")) ~ "HOS",
  positions %in% paste0(sort(rep(LETTERS[1:8], 4)), c("05", "06", "07", "08")) ~ "HCT116",
  positions %in% paste0(sort(rep(LETTERS[1:8], 4)), c("09", "10", "11", "12")) ~ "A375",
  TRUE ~ "error"
)
corresp <- getData(uObj, "classification") %>%
  tibble(oldClass = ., newClass = newClass) %>%
  distinct()

classification(uObj) <- newClass

gm <- getData(uObj, "groupMeans")
colnames(gm) <- pull(corresp, newClass)[match(colnames(gm), pull(corresp, oldClass))]
groupMeans(uObj) <- gm

tm <- getData(uObj, "tsneMeans")
tm$classification <- pull(corresp, newClass)[match(tm$classification, pull(corresp, oldClass))]
tsneMeans(uObj) <- tm

sObj <- spSwarm(spCounts = cObjMul, spUnsupervised = uObj)
```

## spCounts

Plot markers.
```{r}
plotCountsMarkers(cObjSng, cObjMul, markers = c("ALDH1A2", "IL13RA2"))
```

Plot cell number.
```{r}
plotCountsERCC(cObjSng, cObjMul)
```

Get the plotting data so you can make a custom plot.
```{r}
plotCountsMarkers(cObjSng, cObjMul, markers = c("ALDH1A2", "IL13RA2")) %>%
  plotData() %>%
  head()

plotCountsERCC(cObjSng, cObjMul) %>%
  plotData() %>%
  head()
```

## spUnsupervised

Plot the clustering results.
```{r}
plotUnsupervisedClass(uObj, cObjSng)
```

Plot markers in different cell types.
```{r}
plotUnsupervisedMarkers(uObj, cObjSng, markers = c("ALDH1A2", "ADIRF", "IL13RA2"))
```

Plot mean of multiple markers for the same cell type.
```{r, message = FALSE}
#use the data instead
plotUnsupervisedMarkers(uObj, cObjSng, markers = c("COL1A1", "COL1A2", "COL3A1")) %>%
  plotData() %>%
  gather(gene, value, -(Sample:Colour)) %>%
  group_by(Sample) %>%
  mutate(`Mean(markers)` = mean(value)) %>%
  select(`t-SNE dim 1`, `t-SNE dim 2`, `Mean(markers)`) %>%
  distinct() %>%
  ggplot() +
  geom_point(aes(`t-SNE dim 1`, `t-SNE dim 2`, colour = `Mean(markers)`)) +
  viridis::scale_colour_viridis(option = "E") +
  theme_few() +
  theme(legend.position = "top", legend.title.align = 0) +
  guides(colour = guide_colourbar(title.position = "top")) 
```

Get the plotting data so you can make a custom plot.

```{r}
plotUnsupervisedClass(uObj, cObjSng) %>% 
  plotData() %>%
  head()

plotUnsupervisedMarkers(uObj, cObjSng, markers = c("ALDH1A2", "ADIRF", "IL13RA2")) %>% 
  plotData %>%
  head()
```

## spSwarm

### Graph-based plots

```{r}
plotSwarmGraph(sObj, uObj)
```

### Non-graph-based plots

Edge bar graph.
```{r}
plotSwarmEdgeBar(sObj)
```

P-value bar graph.
```{r}
plotSwarmPbar(sObj)
```

Heatmap.
```{r}
plotSwarmHeat(sObj)
```

Get data to make a custom plot.
```{r}
plotSwarmGraph(sObj, uObj) %>%
  plotData()

plotSwarmEdgeBar(sObj) %>%
  plotData() %>%
  head()
```

### Residual plots

